<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle Financeiro</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="container">

<!-- ================= LOGIN ================= -->
<div id="loginBox">
<h1>Login</h1>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Senha">
<button onclick="login()">Entrar</button>
<p id="loginMsg"></p>
</div>

<!-- ================= APP ================= -->
<div id="app" style="display:none">
<h1>Controle Financeiro</h1>
<button onclick="logout()">Sair</button>

<!-- RECEITAS -->
<section>
<h2>Adicionar Receita</h2>
<form id="formReceita">
<input id="rDescricao" placeholder="Descrição" required>
<input id="rValor" type="number" step="0.01" placeholder="Valor" required>
<select id="rTipo">
<option>Salário</option>
<option>Vale Alimentação</option>
<option>Vale Transporte</option>
<option>Extra</option>
<option>Comissão</option>
</select>
<input type="month" id="rMes" required>
<button>Adicionar Receita</button>
</form>
</section>

<!-- GASTOS -->
<section>
<h2>Adicionar Gasto</h2>
<form id="formGasto">
<input id="descricao" placeholder="Descrição" required>
<input id="valor" type="number" step="0.01" placeholder="Valor" required>
<select id="tipo">
<option value="Planejado">Planejado</option>
<option value="NaoPlanejado">Não Planejado</option>
<option value="Fixo">Fixo</option>
</select>
<select id="pagamento">
<option value="avista">À Vista</option>
<option value="parcelado">Parcelado</option>
</select>
<div id="parcelasDiv">
<input id="parcelas" type="number" placeholder="Parcelas">
</div>
<input type="month" id="gMes" required>
<button>Adicionar Gasto</button>
</form>
</section>

<!-- FILTRO -->
<section>
<h2>Filtrar Mês</h2>
<input type="month" id="filtroMes">
</section>

<!-- TABELA -->
<section>
<h2>Gastos</h2>
<table>
<thead>
<tr>
<th>Descrição</th><th>Valor</th><th>Tipo</th><th>Pagamento</th><th>Parcelas</th><th>Mês</th>
</tr>
</thead>
<tbody id="tabelaGastos"></tbody>
<td><button class="delete-btn" onclick="excluirRegistro(id)">X</button></td>
</table>
</section>

<!-- RESUMO -->
<section>
<h2>Resumo</h2>
<div class="resumo-box">
<div>Receitas: R$ <span id="totalReceitas">0</span></div>
<div>Gastos: R$ <span id="totalGastos">0</span></div>
<div>Sobra: R$ <span id="saldoFinal">0</span></div>
</div>
<canvas id="grafico"></canvas>
</section>

</div>
</div>

<script>
// ===== SUPABASE =====
const SUPABASE_URL = "https://mdvuizhxxwfluahwvblj.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1kdnVpemh4eHdmbHVhaHd2YmxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4Njc1NDUsImV4cCI6MjA4NTQ0MzU0NX0.953ZvH6O7FMV3qCdo2YW4NV2I5NK7yiIRTHycv0583s";

const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let user = null;
let grafico = null;

// ===== LOGIN =====
async function login() {
  const emailValue = document.getElementById("email").value;
  const passwordValue = document.getElementById("password").value;

  const { data, error } = await supabaseClient.auth.signInWithPassword({
    email: emailValue,
    password: passwordValue
  });

  if (error) {
    document.getElementById("loginMsg").innerText = error.message;
    return;
  }

  user = data.user;
  iniciarApp();
}

async function logout() {
  await supabaseClient.auth.signOut();
  location.reload();
}

function iniciarApp() {
  document.getElementById("loginBox").style.display = "none";
  document.getElementById("app").style.display = "block";
  carregarTudo();
}

// ===== EVENTOS =====
document.getElementById("pagamento").addEventListener("change", () => {
  document.getElementById("parcelasDiv").style.display =
    pagamento.value === "parcelado" ? "block" : "none";
});

formReceita.onsubmit = async e => {
  e.preventDefault();

  await supabaseClient.from("receitas").insert({
    descricao: rDescricao.value,
    valor: rValor.value,
    tipo: rTipo.value,
    mes: rMes.value,
    user_id: user.id
  });

  formReceita.reset();
  carregarTudo();
};

formGasto.onsubmit = async e => {
  e.preventDefault();

  await supabaseClient.from("gastos").insert({
    descricao: descricao.value,
    valor: valor.value,
    tipo: tipo.value,
    pagamento: pagamento.value,
    parcelas: pagamento.value === "parcelado" ? parcelas.value : "-",
    mes: gMes.value,
    user_id: user.id
  });

  formGasto.reset();
  parcelasDiv.style.display = "none";
  carregarTudo();
};

filtroMes.onchange = carregarTudo;

// ===== DADOS =====
async function carregarTudo() {
  let mes = filtroMes.value;

  let { data: receitas } = await supabaseClient.from("receitas").select().eq("user_id", user.id);
  let { data: gastos } = await supabaseClient.from("gastos").select().eq("user_id", user.id);

  if (mes) {
    receitas = receitas.filter(r => r.mes === mes);
    gastos = gastos.filter(g => g.mes === mes);
  }

  atualizarTabela(gastos);
  atualizarResumo(receitas, gastos);
  atualizarGrafico(gastos);
}

function atualizarTabela(gastos) {
  tabelaGastos.innerHTML = "";

  gastos.forEach(g => {
    tabelaGastos.innerHTML += `
      <tr>
        <td>${g.descricao}</td>
        <td>R$ ${Number(g.valor).toFixed(2)}</td>
        <td>${g.tipo}</td>
        <td>${g.pagamento}</td>
        <td>${g.parcelas}</td>
        <td>${g.mes}</td>
      </tr>`;
  });
}

function atualizarResumo(receitas, gastos) {
  const totalR = receitas.reduce((a, b) => a + Number(b.valor), 0);
  const totalG = gastos.reduce((a, b) => a + Number(b.valor), 0);

  totalReceitas.innerText = totalR.toFixed(2);
  totalGastos.innerText = totalG.toFixed(2);
  saldoFinal.innerText = (totalR - totalG).toFixed(2);
}

function atualizarGrafico(gastos) {
  let p = gastos.filter(g => g.tipo === "Planejado").reduce((a, b) => a + Number(b.valor), 0);
  let n = gastos.filter(g => g.tipo === "NaoPlanejado").reduce((a, b) => a + Number(b.valor), 0);
  let f = gastos.filter(g => g.tipo === "Fixo").reduce((a, b) => a + Number(b.valor), 0);

  if (grafico) grafico.destroy();

  grafico = new Chart(document.getElementById("grafico"), {
    type: "pie",
    data: {
      labels: ["Planejado", "Não Planejado", "Fixo"],
      datasets: [{ data: [p, n, f] }]
    }
  });
}

// ===== AUTO LOGIN =====

supabaseClient.auth.getUser().then(r => {
  if (r.data.user) {
    user = r.data.user;
    iniciarApp();
  }
});
